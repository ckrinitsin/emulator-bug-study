<think>
Alright, I'm trying to figure out why the user is encountering this error when running their QEMU/KVM setup. The error message they're seeing is "KVM is too old to support ic-mode=dual,kernel-irqchip=on". From what I understand, this typically happens when either KVM doesn't have the necessary support or it's a nested KVM scenario. However, in the user's case, both the host and L1 guests are running with recent kernels that should support XIVE.

The user mentioned they're using a pseries machine type and have set up their VMs as follows:

- **L0**: Host system, which supports XIVE.
- **L1**: Guest OS on the host, also supports XIVE through the kernel irqchip.
- **L2**: Nested guest within L1, which shouldn't support XIVE because it's using an older KVM setup for XICS.

From their logs and error messages, it seems that when trying to start a nested L2 guest with `ic-mode=dual,kernel-irqchip=on`, QEMU is throwing an error about incompatible KVM. However, the user points out that both L0 and L1 are up-to-date, so this shouldn't be the case.

I recall that in older versions of QEMU, there was a specific error message related to KVM's compatibility with XIVE features. The user provided a link to the documentation which indicates that certain conditions cause this error. They also mentioned applying a patch and having it merged into QEMU 5.2.0, but despite that, they're still seeing issues.

I think the key here is understanding why the error message is misleading in their setup. Since both L0 and L1 have proper XIVE support, the issue must lie elsewhere, possibly within how KVM handles nested guests or the specific device configurations in QEMU.

To resolve this, I should look into:

1. **QEMU Configuration**: Are they using the correct machine type (pseries) and are all parameters set correctly for nested VMs?
2. **KVM Version**: Ensure that both the host and L1 have KVM versions that support XIVE, especially in a nested environment.
3. **Patch Application**: Confirm if their QEMU was built with the latest patches or if it's still using an older version that might cause this error.
4. **Documentation Update**: The user suggested updating documentation; perhaps ensuring the docs reflect current supported configurations would help others avoid similar confusion.

I should also consider whether there are known issues with nested KVM setups on pseries, especially regarding irqchips and XIVE support. Maybe there's a specific configuration or workaround that can be applied to make it function without hitting this error.

In summary, the user is facing an issue where QEMU incorrectly reports KVM as incompatible when their setup should theoretically support it. The solution likely involves verifying all components (QEMU, KVM) are up-to-date and properly configured for nested environments, along with ensuring that any applied patches have been correctly integrated.
</think>

The error message you're encountering is due to a limitation in the way QEMU interacts with KVM when using certain configurations, particularly with nested virtualization. Here's a breakdown of the situation and how to address it:

### Understanding the Error
The error "KVM is too old to support ic-mode=dual,kernel-irqchip=on" typically occurs when:
1. **Old KVM Version**: Your host or L1 guest's KVM doesn't support the required features.
2. **Nested KVM Issues**: In nested setups, KVM might not handle certain configurations properly.

### Current Setup
Your setup involves:
- **L0 (Host)**: Uses a recent kernel with XIVE support.
- **L1 (Guest on L0)**: Also supports XIVE through the kernel irqchip.
- **L2 (Nested Guest in L1)**: Uses an older KVM approach for XICS, which is incompatible with newer XIVE features.

### Why the Error Occurs
In your case, despite both L0 and L1 being up-to-date, the nested L2 guest triggers this error because it relies on the historical KVM XICS device. This setup isn't compatible with the newer XIVE-based configurations used in L0 and L1.

### Solution
To resolve this issue:
1. **Update QEMU**: Ensure you're using a version of QEMU that includes the necessary patches, like the one applied for 5.2.0.
2. **Adjust Configuration**: Temporarily disable `kernel-irqchip` or use `ic-mode=legacy` in nested guests until full support is available.
3. **Check Documentation**: Review updated documentation regarding KVM and XIVE compatibility to ensure your setup aligns with current recommendations.

### Conclusion
The error you're seeing is a known limitation being addressed by ongoing improvements in QEMU and KVM. By updating your software and adjusting configurations as needed, you can mitigate this issue and successfully run nested VMs.