
qemu-sparc64-static: Segmentation Fault during debootstrap second stage

Host: Ubuntu Precise amd64
Guest: Debian Sid (ports) sparc64

When attempting the second stage of a debootstrap for a sparc64 Debian Sid guest, a segmentation fault occurs.

$ sudo qemu-debootstrap --no-check-gpg --arch=sparc64 sid sparc64 http://ftp.debian-ports.org/debian
I: Running command: debootstrap --arch sparc64 --foreign --no-check-gpg sid sparc64 http://ftp.debian-ports.org/debian
[...]
I: Running command: chroot sparc64 /debootstrap/debootstrap --second-stage
/debootstrap/debootstrap: 22: .: Can't open /usr/share/debootstrap/functions
Segmentation fault (core dumped)

Running a simple "sudo chroot sparc64" exits silently on amd64, and reports a segfault on i386.

ProblemType: Bug
DistroRelease: Ubuntu 12.04
Package: qemu-user-static 1.0.50-2012.03-0ubuntu2.1
ProcVersionSignature: Ubuntu 3.8.0-33.48~precise1-generic 3.8.13.11
Uname: Linux 3.8.0-33-generic x86_64
NonfreeKernelModules: wl
ApportVersion: 2.0.1-0ubuntu17.6
Architecture: amd64
Date: Mon Nov 25 17:49:34 2013
Dependencies:
 
InstallationMedia: Ubuntu 12.04.3 LTS "Precise Pangolin" - Release amd64 (20130820.1)
MarkForUpload: True
ProcEnviron:
 LANGUAGE=en_GB:en
 TERM=xterm
 PATH=(custom, no user)
 LANG=en_GB.UTF-8
 SHELL=/bin/bash
SourcePackage: qemu-linaro
UpgradeStatus: No upgrade log present (probably fresh install)

Version: 1.6.0+dfsg-2ubuntu4

Still in Trusty.

Tried again with today's git and the result is a bit different:

I: Running command: chroot debian-sparc64-sid /debootstrap/debootstrap --second-stage
Unhandled trap: 0x34
pc: 00000000001109a4  npc: 00000000001109a8
%g0-3: 0000000000000000 0000000000000001 0000000000000000 000000000021b800
%g4-7: 000000000b000000 00000040009ddcc0 000000008a116000 0000004000b8e6f0
%o0-3: 0000000000000014 00000040007ff9e9 00000040007ff9e9 0000000000000000 
%o4-7: 0000000000000000 0000000000000000 00000040007ff929 00000040007ffa91 
%l0-3: 0000000000000000 0000000000000000 0000004000801e8b 0000000000116398 
%l4-7: 0000000000000002 0000000000000000 0000000000000000 0000004000b86000 
%i0-3: 0000000000000001 00000000002463a0 0000000000000000 000000000021b800 
%i4-7: 000000000021bad0 0000000000219400 00000040007ffe81 000000000010b174 
%f00:  65636f6e645f7374 ffffffffffffffff 7461676588000000 7365636f6e645f73
%f08:  ffffffffffffffff ffffffffffffffff ffffffffffffffff ffffffffffffffff
%f16:  7b245f2065712024 706b677d20404152 4756293b0a092469 6e20813d20302069
%f24:  662028812f5e2481 2f293b0a09696620 2824696e20616e64 2028812f5e446570
%f32:  656e6473813a2028 2e812a2924812f20 6f7220812f5e5072 65812d446570656e
%f40:  6473813a20282e81 2a2924812f292920 7b0a0909666f7220 2464202873706c69
%f48:  7b0a0909666f7220 2824696e20616e64 2028812f5e446570 656e6473813a2028
%f56:  2e812a2924812f20 6f7220812f5e5072 65812d446570656e 6473813a20282e81
pstate: 00000092 ccr: 44 (icc: -Z-- xcc: -Z--) asi: f0 tl: 0 pil: 0
cansave: 5 canrestore: 1 otherwin: 0 wstate: 0 cleanwin: 7 cwp: 5
fsr: 0000000000000000 y: 0000000000000031 fprs: 0000000000000004

# qemu-sparc64-static -version
qemu-sparc64 version 1.7.50, Copyright (c) 2003-2008 Fabrice Bellard

I am seeing the same:

# qemu-sparc64-static -version
qemu-sparc64 version 2.1.50, Copyright (c) 2003-2008 Fabrice Bellard

This sounds like a distribution specific bug to me, so moving the bug to QEMU-Ubuntu.

Thanks Thomas to reassign so I finally got aware of this.

At least I can confirm the issue on Xenial:
qemu at version 1:2.5+dfsg-5ubuntu10.6

sudo qemu-debootstrap --no-check-gpg --arch=sparc64 sid sparc64 http://ftp.debian-ports.org/debian
[...]
I: Running command: chroot sparc64 /debootstrap/debootstrap --second-stage
Unhandled trap: 0x34
pc: 0000000000110688  npc: 000000000011068c
%g0-3: 0000000000000000 0000000000000001 0000000000218c00 0000000000000000
%g4-7: 0000000000000000 00000000009e3440 00000000000000b1 000000400092a400
%o0-3: 0000000000000014 00000040007ff8e9 00000040007ff8e9 0000000000000000 
%o4-7: 0000000000000000 0000000000000000 00000040007ff829 00000040007ff991 
%l0-3: 0000000000000000 0000000000000000 0000000000000000 0000004000801f00 
%l4-7: 0000000000000000 0000000000000020 0000004000b8f5c8 0000004000b8e000 
%i0-3: 0000000000000001 000000000021e800 000000000021b400 0000000000219000 
%i4-7: 0000000000218800 000000000021b770 00000040007ffdc1 000000000010af14 
%f00:  636865636b696e67 202061766f696420 2020202020207363 7261746368626f78
%f08:  202061766f696420 65290a2020202020 20812d812d6b6579 72696e67813d4b20
%f16:  7573652076617269 616e742058206f66 2074686520626f6f 7473747261702073
%f24:  6372697074730a20 2020202020202020 2020202020202020 2020202020202020
%f32:  2020202028637572 72656e746c792073 7570706f72746564 2076617269616e74
%f40:  73813a206275696c 64642c2066616b65 6368726f6f742c0a 2020202020202020
%f48:  20812d812d6b6579 2020202020202020 2020202020202020 2020202020202020
%f56:  2020202020207363 7261746368626f78 2c206d696e626173 65290a2020202020
pstate: 00000092 ccr: 44 (icc: -Z-- xcc: -Z--) asi: f0 tl: 0 pil: 0
cansave: 3 canrestore: 3 otherwin: 0 wstate: 0 cleanwin: 7 cwp: 5
fsr: 0000000000000000 y: 0000000000000000 fprs: 0000000000000004


Similar for Yakkety:
qemu version 1:2.6.1+dfsg-0ubuntu9

I: Running command: chroot sparc64 /debootstrap/debootstrap --second-stage
Unhandled trap: 0x34
pc: 0000000000110688  npc: 000000000011068c
%g0-3: 0000000000000000 0000000000000001 0000000000218c00 0000000000000000
%g4-7: 0000000000000000 00000000009e3440 0000000000000214 000000400092a400
%o0-3: 0000000000000014 00000040007ffa59 00000040007ffa59 0000000000000000 
%o4-7: 0000000000000000 0000000000000000 00000040007ff999 00000040007ffb01 
%l0-3: 0000000000000000 0000000000000000 0000000000000000 0000004000801f44 
%l4-7: 0000000000000000 0000000000000020 0000004000b8f5c8 0000004000b8e000 
%i0-3: 0000000000000001 0000000000249260 000000000021b400 0000000000219000 
%i4-7: 0000000000218800 000000000021b770 00000040007fff31 000000000010af14 
%f00:  636865636b696e67 202061766f696420 20812d812d6b6579 72696e67813d4b20
%f08:  202061766f696420 202020636865636b 2052656c65617365 2066696c65732061
%f16:  6372697074730a20 2020202020202020 2020202020202020 2020202020202020
%f24:  2020202028637572 72656e746c792073 7570706f72746564 2076617269616e74
%f32:  73813a206275696c 64642c2066616b65 6368726f6f742c0a 2020202020202020
%f40:  2020202020202020 2020202020202020 2020202020207363 7261746368626f78
%f48:  2052656c65617365 2020202020202020 2020202020207363 7261746368626f78
%f56:  2c206d696e626173 65290a2020202020 20812d812d6b6579 72696e67813d4b20
pstate: 00000092 ccr: 44 (icc: -Z-- xcc: -Z--) asi: f0 tl: 0 pil: 0
cansave: 3 canrestore: 3 otherwin: 0 wstate: 0 cleanwin: 7 cwp: 5
fsr: 0000000000000000 y: 0000000000000000 fprs: 0000000000000004


As I expected this is not very "exclusive" linking in the Debian bug

Fails up to Focal (I only tested LTS) but then seems to work fine with Jammy.

I: Running command: chroot sid-sparc64 /debootstrap/debootstrap --second-stage
*** longjmp causes uninitialized stack frame ***: terminated
Segmentation fault (core dumped)

Tried Lunar, Mantic and Noble too and they all work.

Looks like it was fixed somewhere between 4.2 and 6.2.

