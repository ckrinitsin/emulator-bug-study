
Qemu increased memory usage with TCG
Description of problem:
The issue is that instances that are supposed to use only a small amount of memory (like 256MB) suddenly use a much higher amount of RSS when running the accel=tcg, around 512MB in the above example. This was not happening with qemu-4.2 (on Ubuntu 20.04). This is also not happening when using accel=kvm instead. The issue has been first noticed on Debian 11 (Bullseye) with the versions above, but it is happening in the same way on Centos 8 Stream, Ubuntu 21.10 and a pre-release version of Ubuntu 22.04. It also also seen when testing with qemu-6.1 built from source.
Steps to reproduce:
1. Deploy devstack (https://opendev.org/openstack/devstack) with VIRT_TYPE=qemu on a VM
2. Start an instance with cirros image and a flavor allocating 256MB
3. Do a ps and see a RSS size of about 512MB being used after the instance has finished booting
4. Expected result (seen with qemu-4.2 or VIRT_TYPE=kvm): RSS stays < 256MB
Additional information:
I can try to find a smaller commandline for manual reproduction if needed. The above sample is generated by OpenStack Nova via libvirt.
