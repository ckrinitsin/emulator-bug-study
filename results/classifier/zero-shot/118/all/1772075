architecture: 0.906
virtual: 0.897
device: 0.895
permissions: 0.894
performance: 0.886
register: 0.883
assembly: 0.878
semantic: 0.877
debug: 0.876
boot: 0.875
socket: 0.874
arm: 0.871
kernel: 0.871
vnc: 0.869
peripherals: 0.869
KVM: 0.868
TCG: 0.867
network: 0.858
graphic: 0.858
PID: 0.857
ppc: 0.854
x86: 0.853
user-level: 0.842
files: 0.842
hypervisor: 0.833
VMM: 0.830
risc-v: 0.816
mistranslation: 0.757
i386: 0.630

Segmentation fault on aarch64 vm at powerdown

OS Arch Linux
x86_64
qemu version: 2.12

cmdline:
qemu-system-aarch64 -nographic -cpu cortex-a57 -m 2048 -M virt,gic_version=3 -machine virtualization=true -bios /usr/share/ovmf/AARCH64/QEMU_EFI.fd -drive file=fat:rw:/opt/simonpiemu/kernels/rpi-3,if=none,format=raw,cache=none,id=hd0 -device virtio-blk-device,drive=hd0 -drive file=/home/morfeo/.simonpi/sd-arch-rpi-3-qemu.img,if=none,format=raw,cache=none,id=hd1 -device virtio-blk-device,drive=hd1 -kernel /opt/simonpiemu/kernels/rpi-3/Image -append "root=/dev/vda2 fstab=no rootfstype=ext4 rw console=ttyAMA0" -initrd /home/morfeo/.simonpi/rpi-3/boot/initramfs-linux.img -device virtio-net-device,mac=52:54:26:11:72:9b,netdev=net0 -netdev tap,id=net0,ifname=rasp-tap0,script=no,downscript=no

error:

qemu-system-aarch64: /build/qemu/src/qemu-2.12.0/block.c:3375: bdrv_close_all: Assertion `QTAILQ_EMPTY(&all_bdrv_states)' failed.



This bug is present also on AARCH32, ARMv7 architectures


Can you provide the various image files and so on somewhere so that I can reproduce, please? (My aarch64 test image shuts down cleanly, so it may be something specific to the guest you're using.)


QEMU_EFI.fd:
http://snapshots.linaro.org/components/kernel/leg-virt-tianocore-edk2-upstream/latest/QEMU-AARCH64/RELEASE_GCC5/QEMU_EFI.fd

sd-image:
generated as this says:
https://archlinuxarm.org/platforms/armv8/broadcom/raspberry-pi-3
(same error also with latest raspbian image)

kernel image:
https://github.com/M0Rf30/qemu-kernels-rpi-arch-arm/tree/master/rpi3

initrd image:
is indifferent. in cmdline is used the initrd from arch boot partition

on releases previous to 2.12 this error is not present



Could you just provide the files for the sd card and the initrd, please. I don't want to spend a bunch of time trying to recreate them when you already have them...


In order not to upload a big image I can say that you can generate the image with this tool
https://github.com/M0Rf30/simonpi
the initrd used is in the arch linux arm boot partition generated by the previous referenced tool.


As I said, I don't want to have to deal with image generation tools and extracting initrds from disk images. The easiest thing for me is if you can just provide all the files and the command line I can use to reproduce.


https://mega.nz/#!M15RiY5S!7CvVemQAOQnxTcdcRnLNGqxlH6SAeL3oit_uWCs-yck
here the sd image

You can reproduce the bug without any Linux image.

you can quit Qemu (CTRL-A C quit) without the bug reported
qemu-system-aarch64 -M virt -cpu cortex-a57 -nographic -net none -parallel none -bios QEMU_EFI.fd


or generate the bug with:
qemu-system-aarch64 -M virt -cpu cortex-a57 -nographic -net none -parallel none -bios QEMU_EFI.fd  -hda fat:rw:aarch64/virtual_disk

Get into the EFI shell and exit Qemu.
The virtual_disk directory is empty.

Thanks for the repro instructions. I think this bug was fixed by commit 41b6513436d2ebb64c7d, which should be in QEMU version 3.0 or later.


PS: if you can still reproduce with current QEMU please do let me know and I'll reopen the bug and investigate further.


