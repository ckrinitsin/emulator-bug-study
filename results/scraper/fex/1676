Add tests for Context-wide code invalidations
Follow up from #1670, #1558.

Needs the to be part of #1558 or to be done after it, as there's no other way to test it